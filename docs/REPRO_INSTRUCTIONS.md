# Reproducibility instructions (MSIP + Python)

Short, **deterministic** steps to regenerate all public figures from supplied intermediates.

# Reproducibility instructions (MSIP + Python)

This document explains how to regenerate the public figures from the provided code and intermediate exports.

## Environment
- Python packages (see `requirements.txt`): pandas, numpy, scipy, matplotlib, joblib
- Fonts: Arial (used by plotting scripts)

### Quickstart

```bash
# pip
pip install -r requirements.txt

# or: conda
conda env create -f environment.yml
conda activate oab-af-srs
```

## Step 1 — OAB normalization and AF extraction
- **JADER**: `raw_code/jader/01_oab_standardize.py` → outputs `OAB_STD_J(j_id, drug_of_interest)`
- **FAERS**: `raw_code/faers/01_oab_standardize.py` → outputs `OAB_STD_F(primaryid, drug_of_interest)`
- AF selection in MSIP:
  - FAERS: REAC.pt == `"Atrial fibrillation"` → `F_AF(primaryid)`
  - JADER: REAC.有害事象 == `"心房細動"` → `J_AF(j_id)`

## Step 2 — Patient-level IDs and drug counts
- **JADER**: patient-level with `drug_count`
- **FAERS**: deduped PLID with `number_of_drug`
- Logical names are listed in `docs/DATA_INTERFACES.md`.

## Step 3 — 2×2 counts
- Count tables per drug (`n11, n12, n21, n22`) are produced via MSIP according to the specs in `msip/jader/*` and `msip/faers/*`.
- Export as CSV if needed.

## Step 4 — Metrics (ROR/PRR/IC, p-values)
- Run `raw_code/analysis/01_disproportionality.py` inside MSIP with:
  - `table`: totals row `[N, n+1]`
  - `table1`: per-drug `[label, n1+, n11]`
- Output schema includes numeric `p` and `ROR`.
- Remove rows with `n11 < 3` when preparing figures.

## Step 5 — Figure 2 (forest plot)
In MSIP, run `raw_code/plots/forest_plot.py` with `table=` a CSV containing at least
`DB, drug_of_interest, n11, ROR, ROR025, ROR975` (optional: `p`/`p-value`, `PRR025`, `chi2`, `IC025`).
Outputs `figure2_forest_plot.png` and `figure2_forest_plot.tif`.

## Step 6 — Figure 3 (Excel-based)
- Paste metrics into the Excel template or your own sheet:
  - `data/derived/jader_metrics.csv`
  - `data/derived/faers_metrics.csv`

## Step 7 — Figure 4 (volcano)
- Prepare one CSV per drug with columns:  
  `DB, drug_of_interest, Subgroup, n11, n12, n21, n22, ROR, p, PRR, PRR025, PRR975, chi2, IC, IC025, IC975`
- Run `raw_code/plots/volcano_plot.py` in MSIP (table=the CSV).
  - The script auto-normalizes:
    - `p` from `p` or `p-value`
    - `Subgroup`: `≥` → `>=`
  - Output: `volcano_plot.png`
- Optional: legend-only via `raw_code/plots/volcano_legend.py` (output: `volcano_legend_only.png`).

## Step 8 — Figure 5 (TTO distribution: Weibull + histogram + boxplot)
- Input: MSIP table where **column index 2** is `TTO` (days). Negative/zero and NaN are dropped.
- Run: `raw_code/plots/figure5_tto_distribution.py` in MSIP.
- Output: `figure5_tto_distribution.png` (RGB, 300 dpi) and `figure5_tto_distribution.tif`.

## Step 9 — Figure 6 (KM-style, raw TTO)
- Prepare one CSV with at least `DB`, `prod_ai` (drug), and `TTO` (days).
- Run `raw_code/plots/kaplan_meier_raw.py` in MSIP (table=the CSV).
- Output: `figure6_km_raw.png` (180×120 mm, 300 dpi).

## Sensitivity scenarios
- **Scenario 1 (conventional PRR)**: filter on `PRR025 > 1` using `raw_code/analysis/04a_conventional_prr_filter.py`.
- **Scenario 2 (PS-only)**: use PLIDs generated by `msip/*/*_ps_only.md` before counts.
- **Scenario 3 (AF-excluded)**: use PLIDs from `msip/*/*_af_exclude_plid.md` (with Python helpers `05a_*/05b_*`).


---
## Validation checklist

- [ ] Columns are ASCII-only (`chi2`, `p_value`); no mojibake.
- [ ] Rows with `n11 < 3` are removed prior to plotting.
- [ ] Figure 2/3 use the same **thresholds** as the manuscript (ROR, PRR, IC).
- [ ] Figure 6 uses **raw** (untruncated) TTO when producing S5.
- [ ] Seeds (`seed=12345`) are set where applicable for bootstrap elements.
